## Методика тестирования справочников

**Контрольный список для тестирования:**
- Код (число или строка)
- Без кода, без наименования
- Без кода и наименования
- Иерархический (только элементы)
- Иерархический (группы и элементы)
- Подчинённый (один справочник-владелец)
- Подчинённый (много справочников-владельцев)
- Общий реквизит (один и много)
- Табличная часть (одна и много)
- Реквизиты справочника (один и много)
- Реквизиты табличной части (один и много)
- Планы обмена (таблица регистрации изменений)
- Предопределённые элементы (до версии 8.3.3)
- Предопределённые элементы (начиная с версии 8.3.3)
- Иерархические предопределённые (только элементы)
- Иерархические предопределённые (группы и элементы)
- Выгрузка в формат 1С JDTO
- Загрузка JDTO средствами 1С

**Условия наличия системных свойств справочника**

| **Имя свойства**     | **Поле СУБД**  | **Тип данных СУБД**  | **Условие наличия**                       |
|----------------------|----------------|----------------------|-------------------------------------------|
| **Ссылка**           | _IDRRef        | binary(16)           | **Обязательно**                           |
| **ВерсияДанных**     | _Version       | timestamp            | **Обязательно**                           |
| **ПометкаУдаления**  | _Marked        | binary(1)            | **Обязательно**                           |
| **Предопределённый** | _PredefinedID  | binary(16) >= 8.3.3  | **Обязательно**                           |
| **Предопределённый** | _IsMetadata    | binary(1)   < 8.3.3  | >= 8.3.3 Нулевой UUID = обычный элемент   |
|                      |                |                      |  < 8.3.3 0x01 = предопределённый          |
| **Код**              | _Code          | nvarchar или numeric | Опционально                               |
| **Наименование**     | _Description   | nvarchar             | Опционально                               |
| **Родитель**         | _ParentIDRRef  | binary(16)           | Иерархический справочник                  |
| **ЭтоГруппа**        | _Folder        | binary(1)            | Иерархия групп и элементов                |
|                      |                | 0x00 - группа        | *(!) Значение в СУБД инвертировано:*      |
|                      |                | 0x01 - элемент       | *нужно для сортировки групп и элементов*  |
| **Владелец (один)**  | _OwnerIDRRef   | binary(16)           | Опционально                               |
| **Владелец (много)** | _OwnerID_TYPE  | binary(1) = 0x08     | Наличие справочника-владельца             |
|                      | _OwnerID_RTRef | binary(4)            | *Код типа справочника-владельца*          |
|                      | _OwnerID_RRRef | binary(16)           | *Ссылка на элемент справочника-владельца* |
| **[Общий реквизит]** | _Fld<<NN>>     | <тип данных>         | Опционально                               |

[Описание формата 1С JDTO](https://infostart.ru/1c/articles/1481155/)

**Последовательность сериализации системных свойств в формат 1С JDTO**

| **Порядок** | **Свойство в 1С**   | **Свойство JSON объекта** | **Тип данных JSON**      |
|-------------|---------------------|---------------------------|--------------------------|
| 1           | ЭтоГруппа           | IsFolder                  | bool                     |
| 2           | Ссылка              | Ref                       | uuid                     |
| 3           | ПометкаУдаления     | DeletionMark              | bool                     |
| 4           | Владелец            | Owner                     | { #type + #value }       |
| 5           | Родитель            | Parent                    | uuid                     |
| 6           | Код                 | Code                      | string или number        |
| 7           | Наименование        | Description               | string                   |
| 8           | Предопределённый    | PredefinedDataName        | string                   |
| N           | Остальные реквизиты | Как в конфигураторе 1С    | Согласно формату 1С JDTO |
| Z           | Общие реквизиты     | Как в конфигураторе 1С    | Согласно формату 1С JDTO |

```C#
// Алгоритм создания системных свойств справочника в зависимости
// от настроек метаданных и порядка сериализации в формат 1С JDTO

private static void ConfigureCatalog(in MetadataCache cache, in Catalog catalog)
{
  if (catalog.IsHierarchical)
  {
    if (catalog.HierarchyType == HierarchyType.Groups)
    {
      ConfigurePropertyЭтоГруппа(catalog);
    }
  }

  ConfigurePropertyСсылка(catalog);
  ConfigurePropertyПометкаУдаления(catalog);

  List<Guid> owners = cache.GetCatalogOwners(catalog.Uuid);

  if (owners != null && owners.Count > 0)
  {
    ConfigurePropertyВладелец(in catalog, in owners);
  }

  if (catalog.IsHierarchical)
  {
    ConfigurePropertyРодитель(catalog);
  }

  if (catalog.CodeLength > 0)
  {
    ConfigurePropertyКод(catalog);
  }

  if (catalog.DescriptionLength > 0)
  {
    ConfigurePropertyНаименование(catalog);
  }

  ConfigurePropertyПредопределённый(catalog);

  ConfigurePropertyВерсияДанных(catalog);
}
```